{% extends 'base.html' %}
{% block content %}
<div class="row">
  <!-- Left Sidebar (Model Details & Tips) -->
  <div class="col-lg-4 mb-4">
    <div class="card info-card p-3 mb-3 shadow-sm">
      <h6 class="fw-bold text-primary">Model Details</h6>
      <ul class="small mb-0 list-unstyled">
        <li><strong>Model:</strong> WavLM</li>
        <li><strong>Classifier:</strong> Logistic Regression</li>
        <li><strong>Status:</strong> Active</li>
      </ul>
    </div>

    <!-- Tips (Cleaned) -->
    <div class="card tips-card p-3 shadow-sm d-none">
      <h6 class="fw-bold text-success">Tips</h6>
    </div>
  </div>

  <!-- Main Content (Recording & Upload) -->
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="fw-bold text-primary mb-0">Gender Identification</h2>
            <span class="text-muted small">Logistic Regression</span>
          </div>
          <span class="badge bg-light text-dark border">Ready</span>
        </div>

        <!-- Recording Section -->
        <div class="mb-5 border-bottom pb-4">
          <label class="form-label d-block fw-semibold mb-3"><i class="bi bi-mic-fill me-2"></i>Record Audio</label>

          <div class="d-flex gap-3 align-items-center mb-3">
            <button class="btn btn-danger btn-lg px-4" id="recordBtn" type="button">
              <i class="bi bi-mic-fill"></i> Record
            </button>
            <button class="btn btn-secondary btn-lg px-4" id="stopBtn" type="button" disabled>
              <i class="bi bi-stop-fill"></i> Stop
            </button>
          </div>

          <div id="recordingStatus" class="fw-bold text-muted">Click Record to start.</div>

          <div id="recordedAudioContainer" class="mt-3" style="display: none;">
            <label class="small text-muted mb-1">Preview Recording:</label>
            <audio id="audioPlayback" controls class="w-100"></audio>
          </div>
        </div>

        <!-- Upload Section -->
        <div>
          <label class="form-label fw-semibold mb-3"><i class="bi bi-upload me-2"></i>Upload File</label>
          <form action="{{ url_for('gender_predict') }}" method="post" enctype="multipart/form-data" id="genderForm">
            <div class="input-group mb-3">
              <input class="form-control" type="file" name="audio" id="fileInput" accept="audio/*">
            </div>
            <button class="btn btn-primary w-100 fw-bold" type="submit" id="submitBtn">
              Identify Gender
            </button>
          </form>
        </div>

      </div>
    </div>

    <!-- Result Section -->
    {% if result %}
    <div class="card mt-4 border-start border-5 border-primary shadow-sm animate__animated animate__fadeIn">
      <div class="card-body p-4">
        <h5 class="text-muted small text-uppercase mb-3">Analysis Result</h5>

        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h1 class="display-4 fw-bold text-primary m-0">{{ result.label }}</h1>
            <p class="mb-0 text-muted">Prediction Confidence</p>
          </div>
          <i class="bi bi-person-fill display-4 text-secondary opacity-50"></i>
        </div>

        {% if result.probabilities %}
        <div class="mt-4 pt-3 border-top">
          {% for label, prob in result.probabilities.items() %}
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="small fw-bold text-end" style="width: 70px;">{{ label }}</span>
            <div class="progress flex-grow-1" style="height: 8px;">
              <div
                class="progress-bar {% if label == result.label %}bg-primary{% else %}bg-secondary opacity-25{% endif %}"
                style="width: {{ '%.1f' % (prob * 100) }}%;"></div>
            </div>
            <span class="small text-muted" style="width: 40px;">{{ '%.0f' % (prob * 100) }}%</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('recordingStatus');
    const audioPlayback = document.getElementById('audioPlayback');
    const recordedAudioContainer = document.getElementById('recordedAudioContainer');
    const fileInput = document.getElementById('fileInput');

    let mediaRecorder;
    let audioChunks = [];

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      statusEl.innerHTML = '<span class="text-danger">Microphone not supported.</span>';
      return;
    }

    // Preview uploaded file
    fileInput.addEventListener('change', function (e) {
      if (this.files && this.files[0]) {
        const url = URL.createObjectURL(this.files[0]);
        audioPlayback.src = url;
        recordedAudioContainer.style.display = 'block';
        statusEl.textContent = 'File selected. You can listen before identifying.';
        statusEl.className = 'fw-bold text-primary';
      }
    });

    recordBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        const types = ['audio/webm', 'audio/mp4', 'audio/ogg', ''];
        let options = undefined;
        for (let t of types) {
          if (t === '') break;
          if (MediaRecorder.isTypeSupported(t)) {
            options = { mimeType: t };
            break;
          }
        }

        try {
          mediaRecorder = new MediaRecorder(stream, options);
        } catch (e) {
          mediaRecorder = new MediaRecorder(stream);
        }

        audioChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };

        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
          audioPlayback.src = URL.createObjectURL(blob);

          // Show player
          recordedAudioContainer.style.display = 'block';

          let ext = 'webm';
          if (blob.type.includes('mp4') || blob.type.includes('aac')) ext = 'm4a';
          else if (blob.type.includes('wav')) ext = 'wav';

          const file = new File([blob], `mic_recording.${ext}`, { type: blob.type });
          const dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;

          statusEl.textContent = 'Recording saved. Click "Identify Gender" below.';
          statusEl.className = 'fw-bold text-success';
        };

        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        statusEl.innerHTML = '<span class="text-danger fw-bold"><i class="bi bi-record-circle animate__animated animate__flash animate__infinite"></i> Recording...</span>';

      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Mic Error: ' + err.message;
        statusEl.className = 'fw-bold text-danger';
      }
    });

    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        stopBtn.disabled = true;
      }
    });
  });
</script>
{% endblock %}