{% extends 'base.html' %}
{% block content %}
<div class="row animate-fade-in">
  <div class="col-lg-8">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h2 class="mb-1">Speaker Identification</h2>
        <p class="text-muted mb-0">Identify speakers using XLSR-53 + Classifier</p>
      </div>
      <span class="badge bg-primary-subtle text-primary rounded-pill px-3 py-2">Active</span>
    </div>

    <!-- Recording Section -->
    <div class="card p-4 mb-4 border-0 shadow-sm" id="recordingCard">
      <div class="d-flex align-items-center gap-2 mb-4">
        <div class="p-2 bg-danger bg-opacity-10 rounded-circle text-danger">
          <i class="bi bi-mic-fill fs-5"></i>
        </div>
        <h5 class="mb-0">Record Audio</h5>
      </div>

      <div class="d-flex flex-column gap-3">
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-danger" id="recordBtn" type="button">
            <i class="bi bi-mic-fill"></i> Start Recording
          </button>
          <button class="btn btn-secondary" id="stopBtn" type="button" disabled>
            <i class="bi bi-stop-fill"></i> Stop
          </button>
          <button class="btn btn-outline-primary" id="playRecordedBtn" type="button" disabled>
            <i class="bi bi-play-fill"></i> <span class="play-text">Play</span>
          </button>
        </div>

        <!-- Audio Visualizer for Recording -->
        <div id="recordedAudioPlayer" class="d-none">
          <div class="visualizer-container">
            <canvas id="recordingCanvas"></canvas>
          </div>
          <div class="d-flex justify-content-between text-muted small mt-2">
            <span id="recordedCurrentTime">0:00</span>
            <span id="recordedDuration">0:00</span>
          </div>
        </div>

        <div id="recordingStatus" class="text-muted small fw-medium"></div>
        <audio id="audioPlayback" class="d-none"></audio>

        <button class="btn btn-success d-none" id="useRecordingBtn" type="button">
          <i class="bi bi-check-circle"></i> Use This Recording
        </button>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="card p-4 mb-4 border-0 shadow-sm">
      <div class="d-flex align-items-center gap-2 mb-4">
        <div class="p-2 bg-primary bg-opacity-10 rounded-circle text-primary">
          <i class="bi bi-cloud-upload-fill fs-5"></i>
        </div>
        <h5 class="mb-0">Upload Audio File</h5>
      </div>

      <form action="{{ url_for('speaker_predict') }}" method="post" enctype="multipart/form-data" id="speakerForm">
        <div class="mb-4">
          <label class="form-label fw-medium">Select Audio File</label>
          <input class="form-control form-control-lg" type="file" name="audio" id="fileInput" accept="audio/*">
          <div class="form-text">Supported formats: WAV, MP3, FLAC, OGG, M4A, WebM</div>
        </div>

        <!-- Audio Preview for Uploaded File -->
        <div id="uploadedAudioPlayer" class="d-none mb-4">
          <div class="d-flex align-items-center gap-3 mb-3">
            <button class="btn btn-primary rounded-circle p-3" id="playUploadedBtn" type="button"
              style="width: 50px; height: 50px;">
              <i class="bi bi-play-fill fs-4"></i>
            </button>
            <div class="flex-grow-1">
              <div class="visualizer-container mt-0" style="height: 80px;">
                <canvas id="playbackCanvas"></canvas>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-between text-muted small px-1">
            <span id="uploadedCurrentTime">0:00</span>
            <span id="uploadedDuration">0:00</span>
          </div>
        </div>

        <audio id="uploadedAudioPlayback" class="d-none"></audio>

        <button class="btn btn-primary w-100 py-3" type="submit" id="submitBtn">
          <span class="btn-text fw-bold">Identify Speaker</span>
          <span class="spinner-border spinner-border-sm ms-2 d-none" id="spinner"></span>
        </button>
      </form>
    </div>

    {% if result %}
    <div class="card p-4 border-0 shadow-sm animate-fade-in">
      <h5 class="mb-4">Identification Result</h5>
      <div class="text-center mb-5">
        <div class="display-1 mb-2">üó£Ô∏è</div>
        <h3 class="text-capitalize fw-bold text-primary">{{ result.label }}</h3>
        <p class="text-muted">Identified Speaker</p>
      </div>

      {% if result.probabilities %}
      <h6 class="mb-3 text-muted text-uppercase small fw-bold">Confidence Scores</h6>
      <div class="row g-3">
        {% for label, prob in result.probabilities.items() %}
        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3">
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-semibold text-capitalize">{{ label }}</span>
              <span class="fw-bold text-primary">{{ '%.1f' % (prob * 100) }}%</span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar" style="width: {{ prob * 100 }}%; opacity: {{ 0.5 + (prob * 0.5) }}"></div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <div class="col-lg-4">
    <div class="card p-4 mb-4 border-0 shadow-sm">
      <h6 class="fw-bold mb-3">Model Architecture</h6>
      <ul class="list-unstyled small mb-0 d-flex flex-column gap-2">
        <li class="d-flex justify-content-between">
          <span class="text-muted">Embeddings</span>
          <span class="fw-medium">XLSR-53</span>
        </li>
        <li class="d-flex justify-content-between">
          <span class="text-muted">Classifier</span>
          <span class="fw-medium">SVM + PCA</span>
        </li>
        <li class="d-flex justify-content-between">
          <span class="text-muted">Accuracy</span>
          <span class="fw-medium text-success">98.33%</span>
        </li>
        <li class="d-flex justify-content-between">
          <span class="text-muted">Feature Dim</span>
          <span class="fw-medium">1024</span>
        </li>
      </ul>
    </div>

    <div class="card p-4 border-0 shadow-sm bg-primary text-white">
      <h6 class="fw-bold mb-3 text-white">Pro Tips</h6>
      <ul class="small mb-0 ps-3">
        <li class="mb-2">Use clear audio without background noise for best results</li>
        <li class="mb-2">Keep recordings between 3-10 seconds</li>
        <li>Supported formats include WAV, MP3, and WebM</li>
      </ul>
    </div>
  </div>
</div>

<script>
  // Recording functionality
  let mediaRecorder;
  let audioChunks = [];
  let recordedBlob;

  const recordBtn = document.getElementById('recordBtn');
  const stopBtn = document.getElementById('stopBtn');
  const playRecordedBtn = document.getElementById('playRecordedBtn');
  const useRecordingBtn = document.getElementById('useRecordingBtn');
  const audioPlayback = document.getElementById('audioPlayback');
  const recordingStatus = document.getElementById('recordingStatus');
  const fileInput = document.getElementById('fileInput');

  // Uploaded audio elements
  const uploadedAudioPlayback = document.getElementById('uploadedAudioPlayback');
  const playUploadedBtn = document.getElementById('playUploadedBtn');
  const uploadedAudioPlayer = document.getElementById('uploadedAudioPlayer');

  // Immersive background helpers
  const bodyEl = document.body;
  let activePlaybacks = 0;

  function updateAudioMood(mode, isActive) {
    if (mode === 'recording') {
      bodyEl.classList.toggle('audio-recording', Boolean(isActive));
      return;
    }

    if (mode === 'playing') {
      activePlaybacks = Math.max(0, activePlaybacks + (isActive ? 1 : -1));
      if (activePlaybacks > 0) {
        bodyEl.classList.add('audio-playing');
      } else {
        bodyEl.classList.remove('audio-playing');
      }
    }
  }

  // Audio player helper function
  function setupAudioPlayer(audioElement, playButton, currentTimeEl, durationEl, visualizer) {
    let isPlaying = false;
    audioElement.__isTrackingPlayback = false;

    audioElement.addEventListener('loadedmetadata', function () {
      durationEl.textContent = formatTime(audioElement.duration);
    });

    audioElement.addEventListener('timeupdate', function () {
      currentTimeEl.textContent = formatTime(audioElement.currentTime);
    });

    const handlePlay = function () {
      if (!audioElement.__isTrackingPlayback) {
        audioElement.__isTrackingPlayback = true;
        updateAudioMood('playing', true);
      }
      if (visualizer) visualizer.init(audioElement);
    };

    const handlePause = function () {
      if (audioElement.__isTrackingPlayback) {
        audioElement.__isTrackingPlayback = false;
        updateAudioMood('playing', false);
      }
      if (visualizer) visualizer.stop();
    };

    audioElement.addEventListener('play', handlePlay);
    audioElement.addEventListener('pause', handlePause);

    audioElement.addEventListener('ended', function () {
      isPlaying = false;
      if (playButton.querySelector('.play-text')) {
        playButton.querySelector('.play-text').textContent = 'Play';
      }
      playButton.querySelector('i').className = 'bi bi-play-fill' + (playButton.querySelector('i').classList.contains('fs-4') ? ' fs-4' : '');
      handlePause();
    });

    playButton.addEventListener('click', function () {
      if (isPlaying) {
        audioElement.pause();
        if (playButton.querySelector('.play-text')) {
          playButton.querySelector('.play-text').textContent = 'Play';
        }
        playButton.querySelector('i').className = 'bi bi-play-fill' + (playButton.querySelector('i').classList.contains('fs-4') ? ' fs-4' : '');
      } else {
        audioElement.play();
        if (playButton.querySelector('.play-text')) {
          playButton.querySelector('.play-text').textContent = 'Pause';
        }
        playButton.querySelector('i').className = 'bi bi-pause-fill' + (playButton.querySelector('i').classList.contains('fs-4') ? ' fs-4' : '');
      }
      isPlaying = !isPlaying;
    });
  }

  function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
  }

  // Setup recorded audio player
  const recordedAudioPlayer = document.getElementById('recordedAudioPlayer');
  setupAudioPlayer(
    audioPlayback,
    playRecordedBtn,
    document.getElementById('recordedCurrentTime'),
    document.getElementById('recordedDuration'),
    window.recordingVisualizer
  );

  // Setup uploaded audio player
  setupAudioPlayer(
    uploadedAudioPlayback,
    playUploadedBtn,
    document.getElementById('uploadedCurrentTime'),
    document.getElementById('uploadedDuration'),
    window.playbackVisualizer
  );

  recordBtn.addEventListener('click', async function () {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      // Ensure the visualizer is visible BEFORE init so it measures size
      recordedAudioPlayer.classList.remove('d-none');

      // Start visualization
      if (window.recordingVisualizer) {
        await window.recordingVisualizer.init(stream);
      }

      updateAudioMood('recording', true);

      const options = { mimeType: 'audio/webm' };
      mediaRecorder = new MediaRecorder(stream, options);
      audioChunks = [];

      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        // Stop visualization
        if (window.recordingVisualizer) {
          window.recordingVisualizer.stop();
        }

        // Create WebM blob
        recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(recordedBlob);
        audioPlayback.src = audioUrl;
        recordedAudioPlayer.classList.remove('d-none');
        playRecordedBtn.disabled = false;
        useRecordingBtn.classList.remove('d-none');
        recordingStatus.textContent = 'Recording saved. Click Play to listen or Use This Recording to analyze.';
        recordingStatus.className = 'text-success small fw-medium';

        // Stop all tracks
        stream.getTracks().forEach(track => track.stop());
        updateAudioMood('recording', false);
      };

      mediaRecorder.start();
      recordBtn.disabled = true;
      stopBtn.disabled = false;
      playRecordedBtn.disabled = true;
      useRecordingBtn.classList.add('d-none');
      // Already visible above
      recordingStatus.textContent = 'Recording... Speak now.';
      recordingStatus.className = 'text-danger small fw-medium animate-pulse';
    } catch (err) {
      recordingStatus.textContent = 'Error: ' + err.message;
      recordingStatus.className = 'text-danger small fw-medium';
      updateAudioMood('recording', false);
    }
  });

  stopBtn.addEventListener('click', function () {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
      updateAudioMood('recording', false);
    }
  });

  useRecordingBtn.addEventListener('click', function () {
    if (recordedBlob) {
      const file = new File([recordedBlob], 'recording.webm', { type: 'audio/webm' });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;

      // Trigger change event to update UI
      const event = new Event('change');
      fileInput.dispatchEvent(event);

      document.getElementById('speakerForm').scrollIntoView({ behavior: 'smooth' });
      recordingStatus.textContent = 'Recording loaded below.';
    }
  });

  // File input change handler
  fileInput.addEventListener('change', function (e) {
    if (e.target.files.length > 0) {
      const file = e.target.files[0];
      const fileUrl = URL.createObjectURL(file);
      uploadedAudioPlayback.src = fileUrl;
      uploadedAudioPlayer.classList.remove('d-none');

      // Reset play button
      const btn = document.getElementById('playUploadedBtn');
      btn.querySelector('i').className = 'bi bi-play-fill fs-4';
    } else {
      uploadedAudioPlayer.classList.add('d-none');
    }
  });

  // Form submission
  document.getElementById('speakerForm').addEventListener('submit', function () {
    const btn = document.getElementById('submitBtn');
    const spinner = document.getElementById('spinner');
    const btnText = btn.querySelector('.btn-text');

    btn.disabled = true;
    spinner.classList.remove('d-none');
    btnText.textContent = 'Processing...';
  });
</script>
{% endblock %}